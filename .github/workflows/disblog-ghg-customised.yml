name: DisBlog

on:
  discussion:
    types: [created, edited]

permissions:
  contents: write
  discussions: read

jobs:
  create-or-update-post:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ‚úÖ New step: fetch the section name dynamically via GitHub GraphQL API
      - name: Fetch section info via GitHub API
        id: fetch_section
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ github.event.discussion.node_id }}
        run: |
          section_name=$(gh api graphql -f query='
            query($id:ID!){
              node(id:$id){
                ... on Discussion {
                  category {
                    section {
                      name
                    }
                  }
                }
              }
            }' -f id="$DISCUSSION_ID" --jq '.data.node.category.section.name // "NoSection"')
          echo "section_name=$section_name" >> $GITHUB_OUTPUT

      - name: Extract Discussion Data and Convert Markdown
        id: discussion
        run: |
          title=$(echo '${{ github.event.discussion.title }}' | sed 's/"/\\"/g')
          number="${{ github.event.discussion.number }}"
          category_name="${{ github.event.discussion.category.name }}"
          category_slug="${{ github.event.discussion.category.slug }}"
          
          # ‚úÖ Get section name from the previous step
          section_name="${{ steps.fetch_section.outputs.section_name }}"

          if [ -z "$section_name" ] || [ "$section_name" == "null" ]; then
            section_name="NoSection"
          fi

          # Slugify section/category
          section_slug=$(echo "$section_name" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g' | sed 's/[^a-z0-9-]//g')
          if [ -z "$category_slug" ] || [ "$category_slug" == "null" ]; then
            category_slug=$(echo "$category_name" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g' | sed 's/[^a-z0-9-]//g')
          fi
          
          cat << 'MARKDOWN_EOF' > temp_content.md
          ${{ github.event.discussion.body }}
          MARKDOWN_EOF
          
          sed -i 's/<script>/\&lt;script\&gt;/g' temp_content.md
          sed -i 's/<\/script>/\&lt;\/script\&gt;/g' temp_content.md
          sed -i 's/<style>/\&lt;style\&gt;/g' temp_content.md
          sed -i 's/<\/style>/\&lt;\/style\&gt;/g' temp_content.md
          
          npm install -g marked
          html_content=$(marked --gfm --breaks temp_content.md)
          rm temp_content.md
          
          echo "title=$title" >> $GITHUB_OUTPUT
          echo "number=$number" >> $GITHUB_OUTPUT
          echo "category_name=$category_name" >> $GITHUB_OUTPUT
          echo "category_slug=$category_slug" >> $GITHUB_OUTPUT
          echo "section_name=$section_name" >> $GITHUB_OUTPUT
          echo "section_slug=$section_slug" >> $GITHUB_OUTPUT
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$html_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Create or update post from template
        env:
          GIST_URL: ${{ vars.TEMPLATE_GIST_URL }}
          BLOG_NAME: ${{ vars.BLOG_NAME }}
        run: |
          section_slug="${{ steps.discussion.outputs.section_slug }}"
          category_slug="${{ steps.discussion.outputs.category_slug }}"
          post_dir="posts/$section_slug/$category_slug"
          mkdir -p "$post_dir"
          post_file="$post_dir/${{ steps.discussion.outputs.number }}.html"
          
          if [ -f "$post_file" ]; then
            echo "Post exists - updating existing post"
            
            cat << 'CONTENT_EOF' > temp_html_content.html
          ${{ steps.discussion.outputs.content }}
          CONTENT_EOF
            
            python3 << 'PYTHON_EOF'
          import re
          def replace_element_content(html, element_id, new_content):
              opening_pattern = r'<(\w+)([^>]*id=["\']' + re.escape(element_id) + r'["\'][^>]*)>'
              opening_match = re.search(opening_pattern, html)
              if not opening_match:
                  print(f"Warning: Element with id '{element_id}' not found")
                  return html
              element_type = opening_match.group(1)
              pattern = r'(<' + element_type + r'[^>]*id=["\']' + re.escape(element_id) + r'["\'][^>]*>)(.*?)(<\/' + element_type + r'>)'
              def replacer(match):
                  return match.group(1) + new_content + match.group(3)
              return re.sub(pattern, replacer, html, flags=re.DOTALL)

          post_file = "posts/${{ steps.discussion.outputs.section_slug }}/${{ steps.discussion.outputs.category_slug }}/${{ steps.discussion.outputs.number }}.html"
          with open(post_file, 'r') as f:
              existing_html = f.read()
          with open('temp_html_content.html', 'r') as f:
              new_content = f.read().strip()
          new_title = '''${{ steps.discussion.outputs.title }}'''
          existing_html = replace_element_content(existing_html, 'title-forpost', new_title)
          existing_html = replace_element_content(existing_html, 'maincontent-forpost', new_content)
          with open(post_file, 'w') as f:
              f.write(existing_html)
          PYTHON_EOF
            
            rm temp_html_content.html
            
          else
            echo "New post - creating from template"
            curl -s "$GIST_URL" -o template.html
            
            template_content=$(cat template.html)
            title="${{ steps.discussion.outputs.title }}"
            number="${{ steps.discussion.outputs.number }}"
            category_name="${{ steps.discussion.outputs.category_name }}"
            section_name="${{ steps.discussion.outputs.section_name }}"
            repo_path="${{ github.repository }}"
            blog_name="$BLOG_NAME"
            
            escaped_title=$(printf '%s\n' "$title" | sed 's/[/]/\\&/g' | sed 's/&/\\&/g')
            escaped_blog_name=$(printf '%s\n' "$blog_name" | sed 's/[/]/\\&/g' | sed 's/&/\\&/g')
            escaped_repo_path=$(printf '%s\n' "$repo_path" | sed 's/[/]/\\&/g' | sed 's/&/\\&/g')
            escaped_category=$(printf '%s\n' "$category_name" | sed 's/[/]/\\&/g' | sed 's/&/\\&/g')
            escaped_section=$(printf '%s\n' "$section_name" | sed 's/[/]/\\&/g' | sed 's/&/\\&/g')
            
            echo "$template_content" | sed "s|{{ discussion\.title }}|$escaped_title|g" > temp_template.html
            sed "s|{{ discussion\.id }}|$number|g" temp_template.html > temp_template2.html
            sed "s|{{ blog\.name }}|$escaped_blog_name|g" temp_template2.html > temp_template3.html
            sed "s|{{ repo\.path }}|$escaped_repo_path|g" temp_template3.html > temp_template4.html
            sed "s|{{ discussion\.category }}|$escaped_category|g" temp_template4.html > temp_template5.html
            sed "s|{{ discussion\.section }}|$escaped_section|g" temp_template5.html > temp_template6.html
            
            cat << 'CONTENT_EOF' > temp_html_content.html
          ${{ steps.discussion.outputs.content }}
          CONTENT_EOF
            
            python3 << 'PYTHON_EOF'
          import re
          with open('temp_template6.html', 'r') as f:
              template = f.read()
          with open('temp_html_content.html', 'r') as f:
              content = f.read()
          final_html = re.sub(r'\{\{\s*discussion\.content\s*\}\}', content, template)
          post_file = "posts/${{ steps.discussion.outputs.section_slug }}/${{ steps.discussion.outputs.category_slug }}/${{ steps.discussion.outputs.number }}.html"
          with open(post_file, 'w') as f:
              f.write(final_html)
          PYTHON_EOF
            
            rm template.html temp_template*.html temp_html_content.html
          fi
          
      - name: Commit and push changes
        run: |
          git config --local user.email "disblog-bot@noreply.github.com"
          git config --local user.name "DisBlog Bot"
          
          section_slug="${{ steps.discussion.outputs.section_slug }}"
          category_slug="${{ steps.discussion.outputs.category_slug }}"
          post_file="posts/$section_slug/$category_slug/${{ steps.discussion.outputs.number }}.html"
          
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git add "$post_file"
          
          if git ls-files --error-unmatch "$post_file" 2>/dev/null; then
            git commit -m "[DISBLOG] ‚úèÔ∏è Update blog post from discussion #${{ steps.discussion.outputs.number }} in $section_slug/$category_slug: ${{ steps.discussion.outputs.title }}"
          else
            git commit -m "[DISBLOG] üìù Add blog post from discussion #${{ steps.discussion.outputs.number }} in $section_slug/$category_slug: ${{ steps.discussion.outputs.title }}"
          fi
          
          git push
